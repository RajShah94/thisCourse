(function(f){if(typeof window==="undefined"){var c=require("underscore");var g=require("backbone");var b=module.exports=g}else{var c=this._;var g=this.Backbone;var b=this}g.Relational={};g.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable){throw new Error("Max permits acquired")}else{this._permitsUsed++}},release:function(){if(this._permitsUsed===0){throw new Error("All permits released")}else{this._permitsUsed--}},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(h){if(this._permitsUsed>h){throw new Error("Available permits cannot be less than used permits")}this._permitsAvailable=h}};g.BlockingQueue=function(){this._queue=[]};c.extend(g.BlockingQueue.prototype,g.Semaphore,{_queue:null,add:function(h){if(this.isBlocked()){this._queue.push(h)}else{h()}},process:function(){while(this._queue&&this._queue.length){this._queue.shift()()}},block:function(){this.acquire()},unblock:function(){this.release();if(!this.isBlocked()){this.process()}},isBlocked:function(){return this.isLocked()}});g.Relational.eventQueue=new g.BlockingQueue();g.Store=function(){this._collections=[];this._reverseRelations=[]};c.extend(g.Store.prototype,g.Events,{_collections:null,_reverseRelations:null,addReverseRelation:function(i){var h=c.any(this._reverseRelations,function(j){return c.all(i,function(l,k){return l===j[k]})});if(!h&&i.model&&i.type){this._reverseRelations.push(i);if(!i.model.prototype.relations){i.model.prototype.relations=[]}i.model.prototype.relations.push(i);this.retroFitRelation(i)}},retroFitRelation:function(i){var h=this.getCollection(i.model);h.each(function(k){var j=new i.type(k,i)},this)},getCollection:function(h){var i=c.detect(this._collections,function(j){return h===j.model||h.constructor===j.model});if(!i){i=this._createCollection(h)}return i},getObjectByName:function(h){var i=c.reduce(h.split("."),function(j,k){return j[k]},b);return i!==b?i:null},_createCollection:function(i){var h;if(i instanceof g.RelationalModel){i=i.constructor}if(i.prototype instanceof g.RelationalModel.prototype.constructor){h=new g.Collection();h.model=i;this._collections.push(h)}return h},find:function(i,j){var h=this.getCollection(i);return h&&h.get(j)},register:function(i){var h=i.collection;var j=this.getCollection(i);j&&j._add(i);i.bind("destroy",this.unregister,this);i.collection=h},update:function(h){var i=this.getCollection(h);i._onModelEvent("change:"+h.idAttribute,h,i)},unregister:function(h){h.unbind("destroy",this.unregister);var i=this.getCollection(h);i&&i.remove(h)}});g.Relational.store=new g.Store();g.Relation=function(h,i){this.instance=h;i=(typeof i==="object"&&i)||{};this.reverseRelation=c.defaults(i.reverseRelation||{},this.options.reverseRelation);this.reverseRelation.type=!c.isString(this.reverseRelation.type)?this.reverseRelation.type:g[this.reverseRelation.type]||g.Relational.store.getObjectByName(this.reverseRelation.type);this.options=c.defaults(i,this.options,g.Relation.prototype.options);this.key=this.options.key;this.keyContents=this.instance.get(this.key);this.relatedModel=this.options.relatedModel;if(c.isString(this.relatedModel)){this.relatedModel=g.Relational.store.getObjectByName(this.relatedModel)}if(!this.checkPreconditions()){return false}this.instance._relations.push(this);if(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key){g.Relational.store.addReverseRelation(c.defaults({isAutoRelation:true,model:this.relatedModel,relatedModel:this.instance.constructor,reverseRelation:this.options},this.reverseRelation))}this.initialize();c.bindAll(this,"_modelRemovedFromCollection","_relatedModelAdded","_relatedModelRemoved");g.Relational.store.getCollection(this.instance).bind("relational:remove",this._modelRemovedFromCollection);g.Relational.store.getCollection(this.relatedModel).bind("relational:add",this._relatedModelAdded).bind("relational:remove",this._relatedModelRemoved)};g.Relation.extend=g.Model.extend;c.extend(g.Relation.prototype,g.Events,g.Semaphore,{options:{createModels:true,includeInJSON:true,isAutoRelation:false},instance:null,key:null,keyContents:null,relatedModel:null,reverseRelation:null,related:null,_relatedModelAdded:function(j,k,i){var h=this;j.queue(function(){h.tryAddRelated(j,i)})},_relatedModelRemoved:function(i,j,h){this.removeRelated(i,h)},_modelRemovedFromCollection:function(h){if(h===this.instance){this.destroy()}},checkPreconditions:function(){var j=this.instance,h=this.key,m=this.relatedModel;if(!j||!h||!m){console&&console.warn("Relation=%o; no instance, key or relatedModel (%o, %o, %o)",this,j,h,m);return false}if(!(j instanceof g.RelationalModel)){console&&console.warn("Relation=%o; instance=%o is not a Backbone.RelationalModel",this,j);return false}if(!(m.prototype instanceof g.RelationalModel.prototype.constructor)){console&&console.warn("Relation=%o; relatedModel does not inherit from Backbone.RelationalModel (%o)",this,m);return false}if(this instanceof g.HasMany&&this.reverseRelation.type===g.HasMany.prototype.constructor){console&&console.warn("Relation=%o; relation is a HasMany, and the reverseRelation is HasMany as well.",this);return false}if(j._relations.length){var l=c.any(j._relations,function(i){var k=this.reverseRelation.key&&i.reverseRelation.key;return i.relatedModel===m&&i.key===h&&(!k||this.reverseRelation.key===i.reverseRelation.key)},this);if(l){console&&console.warn("Relation=%o between instance=%o.%s and relatedModel=%o.%s already exists",this,j,h,m,this.reverseRelation.key);return false}}return true},setRelated:function(j,h){this.related=j;var i={};i[this.key]=j;this.instance.acquire();this.instance.set(i,c.defaults(h||{},{silent:true}));this.instance.release()},createModel:function(h){if(this.options.createModels&&typeof(h)==="object"){return new this.relatedModel(h)}},_isReverseRelation:function(h){if(h.instance instanceof this.relatedModel&&this.reverseRelation.key===h.key&&this.key===h.reverseRelation.key){return true}return false},getReverseRelations:function(h){var i=[];var j=!c.isUndefined(h)?[h]:this.related&&(this.related.models||[this.related]);c.each(j,function(k){c.each(k.getRelations(),function(l){if(this._isReverseRelation(l)){i.push(l)}},this)},this);return i},sanitizeOptions:function(h){h||(h={});if(h.silent){h=c.extend({},h,{silentChange:true});delete h.silent}return h},destroy:function(){g.Relational.store.getCollection(this.instance).unbind("relational:remove",this._modelRemovedFromCollection);g.Relational.store.getCollection(this.relatedModel).unbind("relational:add",this._relatedModelAdded).unbind("relational:remove",this._relatedModelRemoved);c.each(this.getReverseRelations(),function(h){h.removeRelated(this.instance)},this)}});g.HasOne=g.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(){c.bindAll(this,"onChange");this.instance.bind("relational:change:"+this.key,this.onChange);var i=this.findRelated();this.setRelated(i);var h=this;c.each(h.getReverseRelations(),function(j){j.addRelated(h.instance)})},findRelated:function(i){var j=this.keyContents;var h=null;if(j instanceof this.relatedModel){h=j}else{if(j&&(c.isString(j)||c.isNumber(j)||typeof(j)==="object")){var k=c.isString(j)||c.isNumber(j)?j:j[this.relatedModel.prototype.idAttribute];h=g.Relational.store.find(this.relatedModel,k);if(h&&c.isObject(j)){h.set(j,i)}else{if(!h){h=this.createModel(j)}}}}return h},onChange:function(k,h,j){if(this.isLocked()){return}this.acquire();j=this.sanitizeOptions(j);var n=c.isUndefined(j._related);var l=n?this.related:j._related;if(n){this.keyContents=h;if(h instanceof this.relatedModel){this.related=h}else{if(h){var m=this.findRelated(j);this.setRelated(m)}else{this.setRelated(null)}}}if(l&&this.related!==l){c.each(this.getReverseRelations(l),function(o){o.removeRelated(this.instance,j)},this)}c.each(this.getReverseRelations(),function(o){o.addRelated(this.instance,j)},this);if(!j.silentChange&&this.related!==l){var i=this;g.Relational.eventQueue.add(function(){i.instance.trigger("update:"+i.key,i.instance,i.related,j)})}this.release()},tryAddRelated:function(i,h){if(this.related){return}h=this.sanitizeOptions(h);var j=this.keyContents;if(j&&(c.isString(j)||c.isNumber(j)||typeof(j)==="object")){var k=c.isString(j)||c.isNumber(j)?j:j[this.relatedModel.prototype.idAttribute];if(i.id===k){this.addRelated(i,h)}}},addRelated:function(i,h){if(i!==this.related){var j=this.related||null;this.setRelated(i);this.onChange(this.instance,i,{_related:j})}},removeRelated:function(i,h){if(!this.related){return}if(i===this.related){var j=this.related||null;this.setRelated(null);this.onChange(this.instance,i,{_related:j})}}});g.HasMany=g.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:g.Collection},initialize:function(){c.bindAll(this,"onChange","handleAddition","handleRemoval");this.instance.bind("relational:change:"+this.key,this.onChange);this.collectionType=this.options.collectionType;if(c(this.collectionType).isString()){this.collectionType=g.Relational.store.getObjectByName(this.collectionType)}if(!this.collectionType.prototype instanceof g.Collection.prototype.constructor){throw new Error("collectionType must inherit from Backbone.Collection")}this.setRelated(this.prepareCollection(new this.collectionType()));this.findRelated()},prepareCollection:function(h){if(this.related){this.related.unbind("relational:add",this.handleAddition).unbind("relational:remove",this.handleRemoval)}h.reset();h.model=this.relatedModel;h.bind("relational:add",this.handleAddition).bind("relational:remove",this.handleRemoval);return h},findRelated:function(h){if(this.keyContents&&c.isArray(this.keyContents)){c.each(this.keyContents,function(j){var k=c.isString(j)||c.isNumber(j)?j:j[this.relatedModel.prototype.idAttribute];var i=g.Relational.store.find(this.relatedModel,k);if(i&&c.isObject(j)){i.set(j,h)}else{if(!i){i=this.createModel(j)}}if(i&&!this.related.getByCid(i)&&!this.related.get(i)){this.related._add(i)}},this)}},onChange:function(k,h,j){j=this.sanitizeOptions(j);this.keyContents=h;c.each(this.getReverseRelations(),function(m){m.removeRelated(this.instance,j)},this);if(h instanceof g.Collection){this.prepareCollection(h);this.related=h}else{var l=this.related instanceof g.Collection?this.related:new this.collectionType();this.setRelated(this.prepareCollection(l));this.findRelated(j)}c.each(this.getReverseRelations(),function(m){m.addRelated(this.instance,j)},this);var i=this;g.Relational.eventQueue.add(function(){!j.silentChange&&i.instance.trigger("update:"+i.key,i.instance,i.related,j)})},tryAddRelated:function(i,h){h=this.sanitizeOptions(h);if(!this.related.getByCid(i)&&!this.related.get(i)){var j=c.any(this.keyContents,function(k){var l=c.isString(k)||c.isNumber(k)?k:k[this.relatedModel.prototype.idAttribute];return l&&l===i.id},this);if(j){this.related._add(i,h)}}},handleAddition:function(j,k,i){i=this.sanitizeOptions(i);var h=this;c.each(this.getReverseRelations(j),function(l){l.addRelated(this.instance,i)},this);g.Relational.eventQueue.add(function(){!i.silentChange&&h.instance.trigger("add:"+h.key,j,h.related,i)})},handleRemoval:function(j,k,i){i=this.sanitizeOptions(i);c.each(this.getReverseRelations(j),function(l){l.removeRelated(this.instance,i)},this);var h=this;g.Relational.eventQueue.add(function(){!i.silentChange&&h.instance.trigger("remove:"+h.key,j,h.related,i)})},addRelated:function(j,i){var h=this;j.queue(function(){if(h.related&&!h.related.getByCid(j)&&!h.related.get(j)){h.related._add(j,i)}})},removeRelated:function(i,h){if(this.related.getByCid(i)||this.related.get(i)){this.related.remove(i,h)}}});g.RelationalModel=g.Model.extend({relations:null,_relations:null,_isInitialized:false,_deferProcessing:false,_queue:null,constructor:function(i,j){var h=this;if(j&&j.collection){this._deferProcessing=true;var k=function(l,m){if(l===h){h._deferProcessing=false;h.processQueue();j.collection.unbind("relational:add",k)}};j.collection.bind("relational:add",k);c.defer(function(){k(h)})}this._queue=new g.BlockingQueue();this._queue.block();g.Relational.eventQueue.block();g.Model.prototype.constructor.apply(this,arguments);g.Relational.eventQueue.unblock()},trigger:function(i){if(i.length>5&&"change"===i.substr(0,6)){var h=this,j=arguments;g.Relational.eventQueue.add(function(){g.Model.prototype.trigger.apply(h,j)})}else{g.Model.prototype.trigger.apply(this,arguments)}return this},initializeRelations:function(){this.acquire();this._relations=[];c.each(this.relations,function(h){var i=!c.isString(h.type)?h.type:g[h.type]||g.Relational.store.getObjectByName(h.type);if(i&&i.prototype instanceof g.Relation.prototype.constructor){new i(this,h)}else{console&&console.warn("Relation=%o; missing or invalid type!",h)}},this);this._isInitialized=true;this.release();this.processQueue()},updateRelations:function(h){if(this._isInitialized&&!this.isLocked()){c.each(this._relations,function(i){var j=this.attributes[i.key];if(i.related!==j){this.trigger("relational:change:"+i.key,this,j,h||{})}},this)}},queue:function(h){this._queue.add(h)},processQueue:function(){if(this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()){this._queue.unblock()}},getRelation:function(h){return c.detect(this._relations,function(i){if(i.key===h){return true}},this)},getRelations:function(){return this._relations},fetchRelated:function(m,o){o||(o={});var n=this.getRelation(m),p=n&&n.keyContents,l=p&&c.select(c.isArray(p)?p:[p],function(q){var r=c.isString(q)||c.isNumber(q)?q:q[n.relatedModel.prototype.idAttribute];return r&&!g.Relational.store.find(n.relatedModel,r)},this);if(l&&l.length){var j=c.map(l,function(s){if(typeof(s)==="object"){var r=new n.relatedModel(s)}else{var q={};q[n.relatedModel.prototype.idAttribute]=s;var r=new n.relatedModel(q)}return r},this);if(n.related instanceof g.Collection&&c.isFunction(n.related.url)){var k=n.related.url(j)}if(k&&k!==n.related.url()){var i=c.defaults({error:function(){var q=arguments;c.each(j,function(r){r.destroy();o.error&&o.error.apply(r,q)})},url:k},o,{add:true});var h=[n.related.fetch(i)]}else{var h=c.map(j,function(q){var r=c.defaults({error:function(){q.destroy();o.error&&o.error.apply(q,arguments)}},o);return q.fetch(r)},this)}}return c.isUndefined(h)?[]:h},set:function(i,j){g.Relational.eventQueue.block();var h=g.Model.prototype.set.apply(this,arguments);if(!this._isInitialized&&!this.isLocked()){g.Relational.store.register(this);this.initializeRelations()}else{if(i&&this.idAttribute in i){g.Relational.store.update(this)}}this.updateRelations(j);g.Relational.eventQueue.unblock();return h},unset:function(i,j){g.Relational.eventQueue.block();var h=g.Model.prototype.unset.apply(this,arguments);this.updateRelations(j);g.Relational.eventQueue.unblock();return h},clear:function(i){g.Relational.eventQueue.block();var h=g.Model.prototype.clear.apply(this,arguments);this.updateRelations(i);g.Relational.eventQueue.unblock();return h},change:function(i){var h=this;g.Relational.eventQueue.add(function(){g.Model.prototype.change.apply(h,arguments)})},toJSON:function(){if(this.isLocked()){return this.id}var h=g.Model.prototype.toJSON.call(this);c.each(this._relations,function(i){var j=h[i.key];if(i.options.includeInJSON===true&&j&&c.isFunction(j.toJSON)){this.acquire();h[i.key]=j.toJSON();this.release()}else{if(c.isString(i.options.includeInJSON)){if(j instanceof g.Collection){h[i.key]=j.pluck(i.options.includeInJSON)}else{if(j instanceof g.Model){h[i.key]=j.get(i.options.includeInJSON)}}}else{delete h[i.key]}}},this);return h}});c.extend(g.RelationalModel.prototype,g.Semaphore);var e=g.Collection.prototype._add;g.Collection.prototype._add=function(i,h){if(!(i instanceof g.Model)){var j=g.Relational.store.find(this.model,i[this.model.prototype.idAttribute]);if(j){i=j.set(i,h)}}if(!(i instanceof g.Model)||!(this.get(i)||this.getByCid(i))){i=e.call(this,i,h)}this.trigger("relational:add",i,this,h);return i};var d=g.Collection.prototype._remove;g.Collection.prototype._remove=function(i,h){i=d.call(this,i,h);this.trigger("relational:remove",i,this,h);return i};var a=g.Collection.prototype.trigger;g.Collection.prototype.trigger=function(i){if(i==="add"||i==="remove"||i==="reset"){var h=this,j=arguments;g.Relational.eventQueue.add(function(){a.apply(h,j)})}else{a.apply(this,arguments)}return this}})();