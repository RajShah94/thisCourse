<html>
  <head>
    <title>S3 POST Form</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    <script type="text/javascript" src="plupload/js/plupload.js"></script>
    <script type="text/javascript" src="plupload/js/plupload.silverlight.js"></script>
    <script type="text/javascript" src="plupload/js/plupload.flash.js"></script>
    <script type="text/javascript" src="plupload/js/plupload.html4.js"></script>
    <script type="text/javascript" src="plupload/js/plupload.html5.js"></script>
    
    <script>
        function get_params() {
            var params = window.location.hash.slice(1).split(",")
            var param_obj = {}
            for (var i=0; i<params.length; i++) {
                var param = params[i].split(":")
                param_obj[param[0]] = param[1]
            }
            return param_obj
        }
    
        $(function() {
            
            var params = get_params()
            
            var uploader_params = {
            	// TODO: only flash is allowed for now, until thumbnail upload can be made to work in HTML5
                runtimes : 'flash,', // 'html5,flash,silverlight',
                url : '/',
                max_file_size : '1mb',
                
                multipart: true,
                multipart_params: {
                    'key': 'uploads/${filename}',
                    'Filename': '${filename}', // adding this to keep consistency across the runtimes
                    'acl': 'public-read',
                    //'success_action_redirect': 'http://127.0.0.1:3000/s3/uploaded',
                    'success_action_status': '201',
                    'AWSAccessKeyId' : 'AKIAJLU4UNM7TIOYH6HA',       
                    'policy': params.policy,
                    'signature': params.signature
                },
				
				multi_selection: false,
				
				browse_button : 'pickfiles',
				container : 'container',
                
				filters : [
					{title : "Image files", extensions : "jpg,gif,png"}
				],

                //resize: {width : 800, height : 600, quality : 90},  // Resize images on clientside, if possible
                resize: {}, 
                
                flash_swf_url : 'plupload/js/plupload.flash.swf',
                silverlight_xap_url : 'plupload/js/plupload.silverlight.xap'
            }
            
            window.uploader = new plupload.Uploader(uploader_params)
			
			uploader.bind('Init', function(up, params) {
				//$('#filelist').html("<div>Current runtime: " + params.runtime + "</div>");
				$('#filelist').html("")
				setTimeout(function() { $('#pickfiles').click() }, 200)
			})
			
			uploader.init()
			
			uploader.bind('FilesAdded', function(up, files) {
				$.each(files, function(i, file) {
					$('#filelist').append(
						'<div id="' + file.id + '"><i>Uploading:</i> ' +
						file.name + ' (' + plupload.formatSize(file.size) + ') <b></b>' +
					'</div>');
				})
				$("#pickfiles").hide()
				up.refresh()
				up.start()
		
			});
		
			uploader.bind('UploadProgress', function(up, file) {
				$('#' + file.id + " b").html(file.percent + "%")
				up.refresh()
			});
		
			uploader.bind('Error', function(up, err) {
				$('#filelist').append("<div>Error: " + err.code +
					", Message: " + err.message +
					(err.file ? ", File: " + err.file.name : "") +
					"</div>"
				)
				up.refresh()
			});
		
			uploader.bind('FileUploaded', function(up, file, response) {
				$('#' + file.id + " b").html("DONE")
				
				response = $.parseXML(response.response)
				var key = response.getElementsByTagName("Key")[0].textContent
				
				if (file.already_made_thumbnail) {
					console.log("Thumbnail:", key) 
					return
				} else {
					console.log("Image:", key)
				}
				
				// upload the thumbnail version now, too
				uploader_params.multipart_params.key = 'uploads/thumb-${filename}'
				uploader_params.resize.width = 190
				uploader_params.resize.height = 120
				file.already_made_thumbnail = true
				
				uploader.trigger("UploadFile", file)
			})
            
        })    
    </script>
    
  </head>

  <body>  

	<div id="container">
		<div id="filelist"></div>
		<a id="pickfiles" href="#">[Select file]</a>
	</div>
    

  </body>
</html>