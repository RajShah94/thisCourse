<html>
  <head>
    <title>S3 POST Form</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    <script type="text/javascript" src="plupload/js/plupload.js"></script>
    <script type="text/javascript" src="plupload/js/plupload.silverlight.js"></script>
    <script type="text/javascript" src="plupload/js/plupload.flash.js"></script>
    <script type="text/javascript" src="plupload/js/plupload.html4.js"></script>
    <script type="text/javascript" src="plupload/js/plupload.html5.js"></script>
    
    <script>
        function get_params() {
            var params = window.location.hash.slice(1).split(",")
            var param_obj = {}
            for (var i=0; i<params.length; i++) {
                var param = params[i].split(":")
                param_obj[param[0]] = param[1]
            }
            return param_obj
        }
    
        $(function() {
            
            var params = get_params()
            
            var uploader_params = {
                runtimes : 'flash,html5,silverlight',
                url : '/',
                max_file_size : '10mb',
                
                multipart: true,
                multipart_params: {
                    'key': 'uploads/${filename}',
                    'Filename': '${filename}', // adding this to keep consistency across the runtimes
                    'acl': 'public-read',
                    //'success_action_redirect': 'http://127.0.0.1:3000/s3/uploaded',
                    'success_action_status': '201',
                    'AWSAccessKeyId' : 'AKIAJLU4UNM7TIOYH6HA',       
                    'policy': params.policy,
                    'signature': params.signature
                },

				browse_button : 'pickfiles',
				container : 'container',
                
				filters : [
					{title : "Image files", extensions : "jpg,gif,png"}
				],

                resize : {width : 800, height : 600, quality : 90},  // Resize images on clientside, if possible 
                
                flash_swf_url : 'plupload/js/plupload.flash.swf',
                silverlight_xap_url : 'plupload/js/plupload.silverlight.xap'
            }
            
            window.uploader = new plupload.Uploader(uploader_params)
                        
            uploader.bind('Error', function(up, error) {
                alert("Error code: " + error.status)
            })
            
            uploader.bind('FileUploaded', function(up, file, response) {
                console.log(response)
            })

			uploader.bind('Init', function(up, params) {
				$('#filelist').html("<div>Current runtime: " + params.runtime + "</div>");
			});
		
			$('#uploadfiles').click(function(e) {
				uploader.start();
				e.preventDefault();
			});
		
			uploader.init();
		
			uploader.bind('FilesAdded', function(up, files) {
				$.each(files, function(i, file) {
					$('#filelist').append(
						'<div id="' + file.id + '">' +
						file.name + ' (' + plupload.formatSize(file.size) + ') <b></b>' +
					'</div>');
				});
		
				up.refresh(); // Reposition Flash/Silverlight
			});
		
			uploader.bind('UploadProgress', function(up, file) {
				$('#' + file.id + " b").html(file.percent + "%");
			});
		
			uploader.bind('Error', function(up, err) {
				$('#filelist').append("<div>Error: " + err.code +
					", Message: " + err.message +
					(err.file ? ", File: " + err.file.name : "") +
					"</div>"
				);
		
				up.refresh(); // Reposition Flash/Silverlight
			});
		
			uploader.bind('FileUploaded', function(up, file) {
				if (uploader.already_uploaded) return
				$('#' + file.id + " b").html("100%");
				//var resize_params = $.merge({resize: {width: 100, height: 100, quality: 80}}, uploader_params)
				uploader_params.multipart_params.key = 'uploads/thumb-${filename}'
				uploader_params.resize.width = 190
				uploader_params.resize.height = 120
				//uploader_params.resize = {width: 100, height: 100, quality: 80}
				//uploader.settings = uploader_params 
				uploader.already_uploaded = true
				uploader.trigger("UploadFile", file)
			});

            //var thumbnail_uploader_params = $.merge({}, uploader_params)
            
            //thumbnail_uploader_params.multipart_params.key = 'uploads/thumb-${filename}'
            //thumbnail_uploader_params.resize = {width: 100, height: 100, quality: 80}
            
            
        })    
    </script>
    
  </head>

  <body>  

	<div id="container">
		<div id="filelist">No runtime found.</div>
		<br />
		<a id="pickfiles" href="#">[Select files]</a>
		<a id="uploadfiles" href="#">[Upload files]</a>
	</div>
    

  </body>
</html>