
<html>
<head>
    <script src="jquery.min.js"></script>
    <script src="json2.js"></script>
    <script src="underscore.js"></script>
    <script src="backbone.js"></script>
    <script src="backbone-relational.js"></script>
    <title>Backbone test</title>
    
    <style>
        #content {
            border: 3px solid black;
            width: 960px;
            /* height: 800px; */
            padding: 5px;
        }
        #content .section {
            border: 2px solid black;
            padding: 10px;
            margin: 10px;
            overflow: auto;
        }
        #content .section .item {
            border: 1px solid black;
            padding: 5px;
            margin: 5px;
            /* float:left; */
            width: 200px;
            display: inline-block;
            vertical-align: top;
        }
        h1, h2, h3 {
            margin: 5px 0px 5px 0px;
        }   
        #jsoncode {
            padding: 25px;
        }
    </style>
</head>
<body>

<script>

$(function() {

    Backbone.Model.prototype.idAttribute = "_id";
    
    window.Content = Backbone.RelationalModel.extend({
        relations: [{
            type: Backbone.HasMany,
            key: 'sections',
            relatedModel: 'Section',
            collectionType: 'SectionCollection',
            includeInJSON: '_id',
            reverseRelation: {
                key: 'parent',
                includeInJSON: false
            },
        }],
        urlRoot: '/api/content',
        initialize: function() {
            var self = this 
            this.get('sections').url = function() { return self.url() + "/sections" }
        },
        parse: function(data) {
            $("#jsoncode").html(JSON.stringify(data))
            return data
        }
    })
    
    window.Section = Backbone.RelationalModel.extend({
        relations: [{
            type: Backbone.HasMany,
            key: 'items',
            relatedModel: 'Item',
            collectionType: 'ItemCollection',
            includeInJSON: "_id",
            reverseRelation: {
                key: 'parent',
                includeInJSON: false
            },
        }],
        initialize: function() {
            // this is a hack to force "items" to be a collection rather than an empty list 
            if (this.get('items').length==0)
                this.set({items: [,]})
            var self = this 
            this.get('items').url = function() { return self.url() + "/items" }
            console.log("section created", this)
        }
    })
    
    window.Item = Backbone.RelationalModel.extend({
        initialize: function() {
            //if (!this.id) this.save()
            console.log("item created", this)   
        }
    })
    
    window.SectionCollection = Backbone.Collection.extend({
        model: Section,
        initialize: function() {
            console.log("sectioncollection created", this)   
        }    
    });
    
    window.ItemCollection = Backbone.Collection.extend({
        model: Item,
        initialize: function() {
            console.log("itemcollection created", this)   
        }
    })
    
    window.ItemView = Backbone.View.extend({
        render: function() {
            console.log("itemview render")
            this.el.html("<h3 class='itemtitle'></h3><div class='attributes'></div>")
            this.$('.itemtitle').text(this.model.get("title"))
            this.$('.attributes').text("")
            for (attr in this.model.attributes) {
                if (attr!="title" && attr!="_id" && attr!="parent")
                    this.$('.attributes').append("<div class='attr_" + attr + "'><b>" + attr + ": " + this.model.get(attr) + "</div>")
            }
            return this
        },
        events: {
            "dblclick .itemtitle": "edit"
        },
        initialize: function() {
            this.model.bind('change', this.render, this)
            this.render()
            console.log("itemview initialized")
        },
        edit: function() {
          this.model.save({"title": this.model.get("title") + " :)"})
        }    
    })
    
    window.SectionView = Backbone.View.extend({
        render: function() {
            console.log("section rendering")
            this.el.html("<h2 class='sectiontitle'></h2><div class='items'></div>")
            this.update()
            return this
        },
        events: {
            "dblclick div.name": "edit"
        },
        initialize: function() {
            this.itemViews = {}
            console.log("binding add:items")
            this.model.bind('change', this.update, this)
            this.model.bind("update:items", this.updateItems, this)
            this.model.bind("add:items", this.addItems, this)
            this.model.bind("remove:items", this.removeItems, this)
            this.render()
            for (i in this.model.get('items').models)
                //this.addItems(this.model.get('items').at(i), this.collection)
                this.model.trigger("add:items", this.model.get('items').at(i), this.collection, this)
        },
        edit: function() {
          alert('editing! ' + this.model.attributes)
        },
        updateItems: function(model, coll) {
            //alert('update items')
        },
        addItems: function(model, coll) {
            console.log("addItems:", model)
            var itemEl = $("<span class='item'>").appendTo(this.$(".items"))
            this.itemViews[model.cid] = new ItemView({model: model, el: itemEl})            
        },
        removeItems: function(model, coll) {
            console.log("removeItems:", model)
            $(this.itemViews[model.cid].el).fadeOut(300, function() { $(this).remove() })
            delete this.itemViews[model.cid]
        },
        update: function() {
            this.$('.sectiontitle').text(this.model.get("title"))
        }
    })
    
    window.ContentView = Backbone.View.extend({
        el: $("#content"),
        render: function() {
            console.log("content render")
            this.el.html("<h1 class='title'></h1><div class='sections'></div>")
            this.update()
            return this
        },
        initialize: function() {
            this.sectionViews = {}
            console.log("binding add:sections")
            this.model.bind('change', this.update, this)
            this.model.bind("update:sections", this.updateSections, this)
            this.model.bind("add:sections", this.addSections, this)
            this.model.bind("remove:sections", this.removeSections, this)
            this.render()
        },
        updateSections: function(model, coll) {
            //alert('update sections')
        },
        addSections: function(model, coll) {
            console.log("addSections:", model)
            var sectionEl = $("<div class='section'>").appendTo(this.$('.sections'))
            this.sectionViews[model.cid] = new SectionView({model: model, el: sectionEl})
        },
        removeSections: function(model, coll) {
            console.log("removeSections:", model)
            $(this.sectionViews[model.cid].el).fadeOut(300, function() { $(this).remove() })
            delete this.sectionViews[model.cid]
        },
        update: function() {
            this.$('.title').text(this.model.get("title"))
        }
    })
    
    window.content = new Content({_id: "4eb3315e3df127171700001c"})
    
    window.contentview = new ContentView({model: content})
    
    content.fetch().then(function() {
        //content.get('sections').at(1).set({title: 'Books'})
        //content.get('sections').at(0).set('items', [{stuff: "woooo", _id:33}])

    })
    
})

// content.save().complete(function() {
    // content.get('sections').add({type:"books"})
    // content.get('sections').at(0).save().complete(function() {
        // alert(content.get('sections').at(0).id)
    // })
// })

</script>

<div id="content"></div>

<div id="jsoncode"></div>

</body>
</html>
