
<html>
<head>
    <script src="jquery.min.js"></script>
    <script src="json2.js"></script>
    <script src="underscore.js"></script>
    <script src="backbone.js"></script>
    <script src="backbone-relational.js"></script>
    <title>Backbone test</title>
    
    <style>
        #content {
            border: 3px solid black;
            width: 960px;
            height: 500px;
            padding: 10px;
        }
        #content .section {
            border: 2px solid black;
            padding: 5px;
            margin: 10px;
        }
        #content .section .item {
            border: 1px solid black;
            padding: 5px;
            margin: 5px;
            float:left;
            width: 200px;
        }
        h1, h2 {
            margin: 5px;
        }   
        
    </style>
</head>
<body>

<script>

Backbone.Model.prototype.idAttribute = "_id";

var Content = Backbone.RelationalModel.extend({
    relations: [{
        type: Backbone.HasMany,
        key: 'sections',
        relatedModel: 'Section',
        collectionType: 'SectionCollection',
        includeInJSON: '_id',
        reverseRelation: {
            key: 'parent',
            includeInJSON: false
        },
    }],
    urlRoot: '/api/content',
    initialize: function() {
        if (!this.get('sections'))
            this.save({sections: []})
        var self = this 
        this.get('sections').url = function() { return self.url() + "/sections" }
    },
    // parse: function(response) {
        // var url = this.url()
        // this.get('sections').url = function() { return url + "/sections" }
        // return response
    // }
})

var Section = Backbone.RelationalModel.extend({
    relations: [{
        type: Backbone.HasMany,
        key: 'items',
        relatedModel: 'Item',
        collectionType: 'ItemCollection',
        includeInJSON: "_id",
        reverseRelation: {
            key: 'parent',
            includeInJSON: false
        },
    }],
    initialize: function() {
        //if (!this.id) this.save()
        if (!this.get('items'))
            this.save({items: []})
        var self = this 
        this.get('items').url = function() { return self.url() + "/items" }
    },
    parse: function(response) {
        return response
    }
})

var Item = Backbone.RelationalModel.extend({
    initialize: function() {
        //if (!this.id) this.save()        
    }
})

var SectionCollection = Backbone.Collection.extend({
    model: Section    
});

var ItemCollection = Backbone.Collection.extend({
    model: Item
})

ItemView = Backbone.View.extend({
    tagName : "div",
    className: "item",
    render: function() {
        $(this.el).html("woooo!")
        return this
    },
    events: {
        "dblclick div.name": "edit"
    },
    initialize: function() {
        _.bindAll(this)
        this.model.bind('change', this.render)
        //$(this.el).appendTo("#content")
    },
    edit: function() {
      alert('editing! ' + this.model.attributes)
      //this.model.save({"name": this.model.get("name") + " :)"})
    },
    updateItems: function(model, coll) {
        
    },
    addItems: function(model, coll) {
        this.itemViews[model.cid] = new ItemView({model: model})
    },
    removeItems: function(model, coll) {
        
    },
    update: function() {
        this.$('.title').text(this.model.get("title"))
    }    
})

SectionView = Backbone.View.extend({
    tagName : "div",
    className: "section",
    itemViews: {},
    render: function() {
        $(this.el).html("<h2 class='title'></h2><div class='items'></div>")
        return this
    },
    events: {
        "dblclick div.name": "edit"
    },
    initialize: function() {
        _.bindAll(this)
        this.model.bind('change', this.update)
        this.model.bind("update:items", this.updateItems)
        this.model.bind("add:items", this.addItems)
        this.model.bind("remove:items", this.removeItems)
        //$(this.el).appendTo("#content")
    },
    edit: function() {
      alert('editing! ' + this.model.attributes)
    },
    updateItems: function(model, coll) {
        
    },
    addItems: function(model, coll) {
        var newView = new ItemView({model: model})
        this.itemViews[model.cid] = newView
        this.$(".items").append(newView.render().el)
    },
    removeItems: function(model, coll) {
        $(this.itemViews[model.cid].el).fadeOut(300, function() { $(this).remove() })
        delete this.itemViews[model.cid]
    },
    update: function() {
        this.$('.title').text(this.model.get("title"))
    }
})

ContentView = Backbone.View.extend({
    sectionViews: {},
    render: function() {
        $("#content").html("<h1 class='title'></h1><div class='sections'></div>")
        this.update()
        return this
    },
    initialize: function() {
        this.el = $("#content")
        _.bindAll(this)
        this.model.bind('change', this.update)
        this.model.bind("update:sections", this.updateSections)
        this.model.bind("add:sections", this.addSections)
        this.model.bind("remove:sections", this.removeSections)
        this.render()
    },
    updateSections: function(model, coll) {
        //alert('update sections')
    },
    addSections: function(model, coll) {
        var newView = new SectionView({model: model})
        this.sectionViews[model.cid] = newView
        this.$(".sections").append(newView.render().el)
    },
    removeSections: function(model, coll) {
        $(this.sectionViews[model.cid].el).fadeOut(300, function() { $(this).remove() })
        delete this.sectionViews[model.cid]
    },
    update: function() {
        this.$('.title').text(this.model.get("title"))
    }
})

$(function() {

    content = new Content({_id: "4eae019c3df1271717000003"})
    
    contentview = new ContentView({model: content})
    
    content.fetch().then(function() {
        content.get('sections').at(1).set({title: 'Books'})
    })
    
    
    
})


// content.save().complete(function() {
    // content.get('sections').add({type:"books"})
    // content.get('sections').at(0).save().complete(function() {
        // alert(content.get('sections').at(0).id)
    // })
// })





//content.bind("change:sections", function() { alert("blah") })

//main = new MainView({model: content})

//content.fetch({silent: false})


</script>

<div id="content"></div>

</body>
</html>
