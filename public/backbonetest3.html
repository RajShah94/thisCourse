<html>
<head>
    <script src="jquery.min.js"></script>
    <script src="json2.js"></script>
    <script src="underscore.js"></script>
    <script src="backbone.js"></script>
    <script src="backbone-relational.js"></script>
    <title>Backbone test</title>
    
    <style>
        #content {
            border: 3px solid black;
            width: 960px;
            height: 500px;
        }
    </style>
</head>
<body>

<script>

Backbone.Model.prototype.idAttribute = "_id";

var Content = Backbone.RelationalModel.extend({
    relations: [{
        type: Backbone.HasMany,
        key: 'sections',
        relatedModel: 'Section',
        collectionType: 'SectionCollection',
        includeInJSON: "_id",
        reverseRelation: {
            key: 'parent',
            includeInJSON: false
        },
    }],
    urlRoot: '/api/courses',
    initialize: function() {
        if (!this.get('sections'))
            this.save({sections: []}) 
        this.get('sections').url = this.url() + "/sections"
    }
})

var Section = Backbone.RelationalModel.extend({
    relations: [{
        type: Backbone.HasMany,
        key: 'items',
        relatedModel: 'Item',
        collectionType: 'ItemCollection',
        includeInJSON: "_id",
        reverseRelation: {
            key: 'parent',
            includeInJSON: false
        },
    }],
    initialize: function() {
        //if (!this.id) this.save()
        if (!this.get('items'))
            this.save({items: []})
        //alert(JSON.stringify(this.attributes)) 
        this.get('items').url = this.url() + "/items"
    },
    parse: function(response) {
        return response
    },
})

var Item = Backbone.RelationalModel.extend({
    initialize: function() {
        //if (!this.id) this.save()        
    },
    defaults: {
        
    }
})

var SectionCollection = Backbone.Collection.extend({
    model: Section,
    initialize: function() {
    },
    // url: function() {
        // return this.models[0].get('parent').url() + "/sections" 
    // }    
});

var ItemCollection = Backbone.Collection.extend({
    model: Item,
    // url: function() {
        // return this.models[0].get('parent').url() + "/items" 
    // }    
})

ItemView = Backbone.View.extend({
    tagName : "div",
    className: "item",
    render: function() {
        _(this.attributes).each(function(val, name) {
            this.$("." + name).text(this.model.get(name))
        })
        return this
    },
    events: {
        "dblclick div.name": "edit"
    },
    initialize: function() {
        this.model.bind('change', this.render, this)
        this.model.bind('destroy', this.remove, this)
        _(this.model.attributes).each(function(val, name) {
            $(this.el).append("<div class='" + name + "'>")
        })
        $(this.el).appendTo("#content")
    },
    edit: function() {
      alert('editing! ' + this.model.attributes)
      //this.model.save({"name": this.model.get("name") + " :)"})
    },        
})

SectionView = Backbone.View.extend({
    tagName : "div",
    className: "section",
    render: function() {
        _(this.model.items).each(function(item) {
            item.render()
        })
        return this
    },
    events: {
        "dblclick div.name": "edit"
    },
    initialize: function() {
        this.model.bind('change', this.render, this)
        this.model.bind('destroy', this.remove, this)
        _(this.attributes).each(function(val, name) {
            $(this.el).append("<div class='" + name + "'>")
        })
        $(this.el).appendTo("#content")
    },
    edit: function() {
      alert('editing! ' + this.model.attributes)
      //this.model.save({"name": this.model.get("name") + " :)"})
    },        
})

MainView = Backbone.View.extend({
    el: $("#content"),
    render: function() {
        _(this.model.sections).each(function(section) {
            section.render()
        })
        return this
    },
    initialize: function() {

        this.model.bind('reset', this.render, this);

    }
})

content = new Content({_id: "4e922db06ec0e63c9fc6fa51"})
//content.bind("change:sections", function() { alert("blah") })
content.fetch({silent: false})

main = new MainView({model: content})

</script>

<div id="content"></div>

</body>
</html>
