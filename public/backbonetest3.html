
<html>
<head>
    <script src="jquery.min.js"></script>
    <script src="json2.js"></script>
    <script src="underscore.js"></script>
    <script src="backbone.js"></script>
    <script src="backbone-relational.js"></script>
    <title>Backbone test</title>
    
    <style>
        #content {
            border: 3px solid black;
            width: 960px;
            height: 500px;
        }
    </style>
</head>
<body>

<script>

Backbone.Model.prototype.idAttribute = "_id";

var Content = Backbone.RelationalModel.extend({
    relations: [{
        type: Backbone.HasMany,
        key: 'sections',
        relatedModel: 'Section',
        collectionType: 'SectionCollection',
        includeInJSON: '_id',
        reverseRelation: {
            key: 'parent',
            includeInJSON: false
        },
    }],
    urlRoot: '/api/content',
    initialize: function() {
        if (!this.get('sections'))
            this.save({sections: []})
        var self = this 
        this.get('sections').url = function() { return self.url() + "/sections" }
    },
    // parse: function(response) {
        // var url = this.url()
        // this.get('sections').url = function() { return url + "/sections" }
        // return response
    // }
})

var Section = Backbone.RelationalModel.extend({
    relations: [{
        type: Backbone.HasMany,
        key: 'items',
        relatedModel: 'Item',
        collectionType: 'ItemCollection',
        includeInJSON: "_id",
        reverseRelation: {
            key: 'parent',
            includeInJSON: false
        },
    }],
    initialize: function() {
        //if (!this.id) this.save()
        if (!this.get('items'))
            this.save({items: []})
        var self = this 
        this.get('items').url = function() { return self.url() + "/items" }
    },
    parse: function(response) {
        return response
    }
})

var Item = Backbone.RelationalModel.extend({
    initialize: function() {
        //if (!this.id) this.save()        
    }
})

var SectionCollection = Backbone.Collection.extend({
    model: Section    
});

var ItemCollection = Backbone.Collection.extend({
    model: Item
})

ItemView = Backbone.View.extend({
    tagName : "div",
    className: "item",
    render: function() {
        _(this.attributes).each(function(val, name) {
            this.$("." + name).text(this.model.get(name))
        })
        return this
    },
    events: {
        "dblclick div.name": "edit"
    },
    initialize: function() {
        this.model.bind('change', this.render, this)
        this.model.bind('destroy', this.remove, this)
        _(this.model.attributes).each(function(val, name) {
            $(this.el).append("<div class='" + name + "'>")
        })
        $(this.el).appendTo("#content")
    },
    edit: function() {
      alert('editing! ' + this.model.attributes)
      //this.model.save({"name": this.model.get("name") + " :)"})
    },        
})

SectionView = Backbone.View.extend({
    tagName : "div",
    className: "section",
    render: function() {
        _(this.model.items).each(function(item) {
            item.render()
        })
        return this
    },
    events: {
        "dblclick div.name": "edit"
    },
    initialize: function() {
        this.model.bind('change', this.render, this)
        this.model.bind('destroy', this.remove, this)
        _(this.attributes).each(function(val, name) {
            $(this.el).append("<div class='" + name + "'>")
        })
        $(this.el).appendTo("#content")
    },
    edit: function() {
      alert('editing! ' + this.model.attributes)
      //this.model.save({"name": this.model.get("name") + " :)"})
    },        
})

MainView = Backbone.View.extend({
    el: $("#content"),
    render: function() {
        alert('main render')
        _(this.model.get('sections').models).each(function(section) {
            section.render()
        })
        return this
    },
    initialize: function() {
        
        this.model.bind('reset', this.render, this)
        this.model.bind('change', this.render, this)

    }
})

content = new Content()

mainview = new MainView({model: content})

content.save().complete(function() {
    content.get('sections').add({type:"books"})
    content.get('sections').at(0).save().complete(function() {
        alert(content.get('sections').at(0).id)
        mainview.render()
    })
})





//content.bind("change:sections", function() { alert("blah") })

//main = new MainView({model: content})

//content.fetch({silent: false})


</script>

<div id="content"></div>

</body>
</html>
